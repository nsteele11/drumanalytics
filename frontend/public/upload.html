<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Upload</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <!-- Navigation bar -->
    <nav>
        <a href="index.html" class="active">Instagram Insights</a>
        <a href="upload.html">Video Upload</a>
        <a href="audio.html">Audio Analytics</a>
    </nav>
  
    <main>
        <h1>Video Upload</h1>

        <div class="section-placeholder">
            <form id="uploadForm">
                <!-- Artist Selection -->
                <label for="artist-search">Artist:</label><br>
                <input type="text" id="artist-search" placeholder="Type artist name" autocomplete="off">
                <ul id="artist-results"></ul><br>

                <!-- Track Selection -->
                <label for="track-search">Track:</label><br>
                <input type="text" id="track-search" placeholder="Select track" autocomplete="off" disabled>
                <ul id="track-results"></ul><br>

                <!-- Video Upload -->
                <label for="videoFile">Select a video file:</label><br>
                <input type="file" id="videoFile" name="videoFile" accept="video/*" required><br><br>

                <button type="submit">Upload Video</button>
            </form>

            <div id="uploadStatus"></div>
        </div>
    </main>

    <script>
        let selectedArtistId = null;
        let selectedTrackId = null;

        const form = document.getElementById('uploadForm');
        const statusDiv = document.getElementById('uploadStatus');

        // ---------------------
        // ARTIST SEARCH
        // ---------------------
        document.getElementById('artist-search').addEventListener('input', async (e) => {
            const query = e.target.value;
            const resultsList = document.getElementById('artist-results');
            resultsList.innerHTML = '';

            if (!query) return;

            try {
                const res = await fetch(`/api/spotify/search/artists?q=${encodeURIComponent(query)}`);
                const artists = await res.json();

                artists.forEach(artist => {
                    const li = document.createElement('li');
                    li.textContent = `${artist.name} (${artist.followers} followers)`;
                    li.style.cursor = 'pointer';
                    li.addEventListener('click', () => {
                        selectedArtistId = artist.spotify_artist_id;
                        document.getElementById('artist-search').value = artist.name;
                        resultsList.innerHTML = '';

                        // enable track search now
                        const trackInput = document.getElementById('track-search');
                        trackInput.disabled = false;
                        trackInput.value = '';
                        selectedTrackId = null;
                        document.getElementById('track-results').innerHTML = '';
                    });
                    resultsList.appendChild(li);
                });
            } catch (err) {
                console.error("Artist search failed:", err);
            }
        });

        // ---------------------
        // TRACK SEARCH
        // ---------------------
        document.getElementById('track-search').addEventListener('input', async (e) => {
            const query = e.target.value;
            const resultsList = document.getElementById('track-results');
            resultsList.innerHTML = '';

            if (!query || !selectedArtistId) return;

            try {
                const res = await fetch(`/api/spotify/search/tracks?artistId=${selectedArtistId}&q=${encodeURIComponent(query)}`);
                const tracks = await res.json();

                tracks.forEach(track => {
                    const li = document.createElement('li');
                    li.textContent = track.name;
                    li.style.cursor = 'pointer';
                    li.addEventListener('click', () => {
                        selectedTrackId = track.id;
                        document.getElementById('track-search').value = track.name;
                        resultsList.innerHTML = '';
                    });
                    resultsList.appendChild(li);
                });
            } catch (err) {
                console.error("Track search failed:", err);
            }
        });

        // ---------------------
        // VIDEO UPLOAD
        // ---------------------
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const fileInput = document.getElementById('videoFile');
            const file = fileInput.files[0];

            if (!file) {
                alert("Please select a video file");
                return;
            }

            if (!selectedArtistId || !selectedTrackId) {
                alert("Please select an artist and track");
                return;
            }

            statusDiv.innerHTML = `<p>Uploading <strong>${file.name}</strong>...</p>`;

            const formData = new FormData();
            formData.append('video', file);
            formData.append('artistId', selectedArtistId);
            formData.append('trackId', selectedTrackId);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.status}`);
                }

                const result = await response.json();
                statusDiv.innerHTML += `<p>Upload complete!</p>`;
                console.log("Upload response:", result);

            } catch (err) {
                console.error(err);
                statusDiv.innerHTML += `<p style="color:red">Upload failed</p>`;
            }
        });
    </script>
</body>
</html>