<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Analytics</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <style>
        .analysis-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .refresh-btn {
            padding: 10px 20px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .refresh-btn:hover {
            background-color: #555;
        }
        
        .refresh-btn:disabled {
            background-color: #999;
            cursor: not-allowed;
        }
        
        .loading-indicator {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .error-message {
            display: none;
            padding: 15px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            color: #721c24;
            margin-bottom: 20px;
        }
        
        .analysis-section {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .analysis-section h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
            font-size: 24px;
        }
        
        .analysis-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #555;
            font-size: 18px;
        }
        
        .metadata-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .metadata-item {
            flex: 1;
            min-width: 150px;
        }
        
        .metadata-item strong {
            display: block;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .metadata-item span {
            display: block;
            color: #333;
            font-size: 16px;
            font-weight: 500;
        }
        
        .signal-card {
            background-color: #f9f9f9;
            border-left: 4px solid #ffcc00;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        
        .signal-card.positive {
            border-left-color: #28a745;
        }
        
        .signal-card.negative {
            border-left-color: #dc3545;
        }
        
        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .signal-feature {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }
        
        .signal-value {
            color: #666;
            font-size: 14px;
        }
        
        .signal-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .signal-metric {
            display: flex;
            flex-direction: column;
        }
        
        .signal-metric-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .signal-metric-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .signal-metric-value.positive {
            color: #28a745;
        }
        
        .signal-metric-value.negative {
            color: #dc3545;
        }
        
        .video-comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .video-comparison-table th,
        .video-comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .video-comparison-table th {
            background-color: #f9f9f9;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        .video-comparison-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .performance-rank {
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
        }
        
        .performance-rank.high {
            background-color: #d4edda;
            color: #155724;
        }
        
        .performance-rank.medium {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .performance-rank.low {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .overlap-count {
            display: inline-block;
            padding: 3px 8px;
            background-color: #e7f3ff;
            color: #004085;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .traits-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .trait-tag {
            display: inline-block;
            padding: 3px 8px;
            background-color: #e9ecef;
            color: #495057;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .trait-tag.overlap {
            background-color: #d4edda;
            color: #155724;
        }
        
        .trait-tag.unique {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .collapsible-section {
            margin-top: 15px;
        }
        
        .collapsible-header {
            cursor: pointer;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .collapsible-header:hover {
            background-color: #e0e0e0;
        }
        
        .collapsible-content {
            display: none;
            padding: 15px;
            margin-top: 10px;
        }
        
        .collapsible-content.expanded {
            display: block;
        }
        
        .toggle-icon {
            transition: transform 0.2s;
        }
        
        .collapsible-header.expanded .toggle-icon {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <nav>
        <a href="index.html">Instagram Insights</a>
        <a href="prerecording.html">Pre Recording</a>
        <a href="upload.html">Video Upload</a>
        <a href="videos.html">Videos</a>
        <a href="audio.html" class="active">Audio Analytics</a>
    </nav>

    <main>
        <div class="analysis-container">
            <div class="analysis-header">
                <h1>Performance Analytics</h1>
                <button id="refreshBtn" class="refresh-btn" onclick="loadAnalysis()">
                    üîÑ Refresh Data
                </button>
            </div>

            <div id="loading" class="loading-indicator">
                <p>Analyzing video performance data...</p>
            </div>

            <div id="error" class="error-message"></div>

            <div id="analysisContent" style="display: none;">
                <!-- Metadata Info -->
                <div class="analysis-section">
                    <h2>Analysis Overview</h2>
                    <div id="metadataInfo" class="metadata-info"></div>
                </div>

                <!-- Early Signal Summary -->
                <div class="analysis-section">
                    <h2>Early Signal Summary</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Features that show directional signals (lift > 1.0 indicates positive association). 
                        <em>Note: All results are labeled as "early signal" and not statistically validated.</em>
                    </p>
                    <div id="earlySignals"></div>
                </div>

                <!-- What Seems to Be Working -->
                <div class="analysis-section">
                    <h2>What Seems to Be Working</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Top-performing metadata patterns ranked by lift and consistency with top 30% performers.
                    </p>
                    <div id="whatSeemsWorking"></div>
                </div>

                <!-- Per-Video Comparison -->
                <div class="analysis-section">
                    <h2>Per-Video Comparison</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Individual video performance with metadata overlap against top 30% performers.
                    </p>
                    <div id="perVideoComparison"></div>
                </div>

                <!-- Rank Association -->
                <div class="analysis-section collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h2 style="margin: 0;">Rank Association Analysis</h2>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <p style="color: #666; margin-bottom: 20px;">
                            Average performance rank by metadata value. Positive values indicate above-median performance.
                        </p>
                        <div id="rankAssociation"></div>
                    </div>
                </div>

                <!-- Distribution Summary -->
                <div class="analysis-section collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h2 style="margin: 0;">Distribution Summary</h2>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <p style="color: #666; margin-bottom: 20px;">
                            Distribution statistics for each metadata feature.
                        </p>
                        <div id="distributionSummary"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        async function loadAnalysis() {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const contentDiv = document.getElementById('analysisContent');
            const refreshBtn = document.getElementById('refreshBtn');

            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            contentDiv.style.display = 'none';
            refreshBtn.disabled = true;
            refreshBtn.textContent = '‚è≥ Loading...';

            try {
                const response = await fetch('/api/performance-analysis');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                loadingDiv.style.display = 'none';
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'üîÑ Refresh Data';

                if (data.error) {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = data.error;
                    return;
                }

                // Display the analysis results
                displayAnalysis(data);
                contentDiv.style.display = 'block';

            } catch (err) {
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = `Error loading analysis: ${err.message}`;
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'üîÑ Refresh Data';
                console.error('Error loading analysis:', err);
            }
        }

        function displayAnalysis(data) {
            // Display metadata info
            displayMetadataInfo(data.analysis_metadata);
            
            // Display early signals
            displayEarlySignals(data.early_signal_summary);
            
            // Display what seems working
            displayWhatSeemsWorking(data.what_seems_working);
            
            // Display per-video comparison
            displayPerVideoComparison(data.per_video_comparison);
            
            // Display rank association
            displayRankAssociation(data.rank_association);
            
            // Display distribution summary
            displayDistributionSummary(data.distribution_summary);
        }

        function displayMetadataInfo(metadata) {
            const container = document.getElementById('metadataInfo');
            if (!metadata) {
                container.innerHTML = '<p>No metadata available</p>';
                return;
            }

            container.innerHTML = `
                <div class="metadata-item">
                    <strong>Total Videos</strong>
                    <span>${metadata.total_videos || 0}</span>
                </div>
                <div class="metadata-item">
                    <strong>Videos with Metrics</strong>
                    <span>${metadata.videos_with_metrics || 0}</span>
                </div>
                <div class="metadata-item">
                    <strong>Confidence Level</strong>
                    <span>${metadata.confidence_level || 'early_signal'}</span>
                </div>
                <div class="metadata-item">
                    <strong>Analysis Date</strong>
                    <span>${metadata.analysis_date ? formatDate(metadata.analysis_date) : 'N/A'}</span>
                </div>
            `;
        }

        function displayEarlySignals(signals) {
            const container = document.getElementById('earlySignals');
            
            if (!signals || signals.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No early signals found. Need more data with metrics.</p></div>';
                return;
            }

            container.innerHTML = signals.map(signal => {
                const avgLift = (signal.lift_views + signal.lift_likes) / 2;
                const cardClass = avgLift > 1.0 ? 'positive' : avgLift < 1.0 ? 'negative' : '';
                
                return `
                    <div class="signal-card ${cardClass}">
                        <div class="signal-header">
                            <div>
                                <span class="signal-feature">${escapeHtml(signal.feature)}</span>
                                <span class="signal-value">: ${escapeHtml(signal.value)}</span>
                            </div>
                            <span style="font-size: 12px; color: #666;">n=${signal.sample_size}</span>
                        </div>
                        <div class="signal-metrics">
                            <div class="signal-metric">
                                <span class="signal-metric-label">Views Lift</span>
                                <span class="signal-metric-value ${signal.lift_views > 1.0 ? 'positive' : signal.lift_views < 1.0 ? 'negative' : ''}">
                                    ${signal.lift_views.toFixed(2)}x
                                </span>
                            </div>
                            <div class="signal-metric">
                                <span class="signal-metric-label">Likes Lift</span>
                                <span class="signal-metric-value ${signal.lift_likes > 1.0 ? 'positive' : signal.lift_likes < 1.0 ? 'negative' : ''}">
                                    ${signal.lift_likes.toFixed(2)}x
                                </span>
                            </div>
                            <div class="signal-metric">
                                <span class="signal-metric-label">Confidence</span>
                                <span class="signal-metric-value">${signal.confidence || 'early'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayWhatSeemsWorking(working) {
            const container = document.getElementById('whatSeemsWorking');
            
            if (!working || working.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No clear patterns identified yet.</p></div>';
                return;
            }

            container.innerHTML = working.map(item => {
                const avgLift = (item.lift_views + item.lift_likes) / 2;
                const cardClass = avgLift > 1.0 ? 'positive' : '';
                
                return `
                    <div class="signal-card ${cardClass}">
                        <div class="signal-header">
                            <div>
                                <span class="signal-feature">${escapeHtml(item.feature)}</span>
                                <span class="signal-value">: ${escapeHtml(item.value)}</span>
                            </div>
                            <span style="font-size: 12px; color: #666;">n=${item.sample_size}</span>
                        </div>
                        <div class="signal-metrics">
                            <div class="signal-metric">
                                <span class="signal-metric-label">Views Lift</span>
                                <span class="signal-metric-value ${item.lift_views > 1.0 ? 'positive' : 'negative'}">
                                    ${item.lift_views.toFixed(2)}x
                                </span>
                            </div>
                            <div class="signal-metric">
                                <span class="signal-metric-label">Likes Lift</span>
                                <span class="signal-metric-value ${item.lift_likes > 1.0 ? 'positive' : 'negative'}">
                                    ${item.lift_likes.toFixed(2)}x
                                </span>
                            </div>
                            <div class="signal-metric">
                                <span class="signal-metric-label">Top 30% Appearances</span>
                                <span class="signal-metric-value">${item.appearances_in_top_30_percent || 0}</span>
                            </div>
                            <div class="signal-metric">
                                <span class="signal-metric-label">Consistency Score</span>
                                <span class="signal-metric-value">${(item.consistency_score || 0).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayPerVideoComparison(videos) {
            const container = document.getElementById('perVideoComparison');
            
            if (!videos || videos.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No video comparison data available.</p></div>';
                return;
            }

            const tableHTML = `
                <table class="video-comparison-table">
                    <thead>
                        <tr>
                            <th>Video</th>
                            <th>Platform</th>
                            <th>Performance Rank</th>
                            <th>Views</th>
                            <th>Likes</th>
                            <th>Engagement</th>
                            <th>Overlap Count</th>
                            <th>Traits</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${videos.map(video => {
                            const rankClass = video.performance_rank >= 7 ? 'high' : video.performance_rank >= 4 ? 'medium' : 'low';
                            const overlapTraits = video.metadata_overlap_with_top_30_percent?.traits || [];
                            const uniqueTraits = video.unique_traits || [];
                            
                            return `
                                <tr>
                                    <td>
                                        <strong>${escapeHtml(video.trackName)}</strong><br>
                                        <small style="color: #666;">${escapeHtml(video.artistName)}</small>
                                    </td>
                                    <td>${escapeHtml(video.platform || 'unknown')}</td>
                                    <td>
                                        <span class="performance-rank ${rankClass}">
                                            ${video.performance_rank.toFixed(2)}
                                        </span>
                                    </td>
                                    <td>${(video.views || 0).toLocaleString()}</td>
                                    <td>${(video.likes || 0).toLocaleString()}</td>
                                    <td>${(video.engagement_proxy || 0).toFixed(3)}</td>
                                    <td>
                                        <span class="overlap-count">${overlapTraits.length}</span>
                                    </td>
                                    <td>
                                        <div class="traits-list">
                                            ${overlapTraits.map(t => `
                                                <span class="trait-tag overlap" title="${escapeHtml(t.feature)}: ${escapeHtml(t.value)}">
                                                    ${escapeHtml(t.feature.substring(0, 15))}
                                                </span>
                                            `).join('')}
                                            ${uniqueTraits.slice(0, 3).map(t => `
                                                <span class="trait-tag unique" title="${escapeHtml(t.feature)}: ${escapeHtml(t.value)}">
                                                    ${escapeHtml(t.feature.substring(0, 15))}
                                                </span>
                                            `).join('')}
                                            ${uniqueTraits.length > 3 ? `<span class="trait-tag">+${uniqueTraits.length - 3} more</span>` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        function displayRankAssociation(ranks) {
            const container = document.getElementById('rankAssociation');
            
            if (!ranks || ranks.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No rank association data available.</p></div>';
                return;
            }

            container.innerHTML = ranks.slice(0, 20).map(item => {
                const cardClass = item.vs_median_rank > 0 ? 'positive' : item.vs_median_rank < 0 ? 'negative' : '';
                
                return `
                    <div class="signal-card ${cardClass}">
                        <div class="signal-header">
                            <div>
                                <span class="signal-feature">${escapeHtml(item.feature)}</span>
                                <span class="signal-value">: ${escapeHtml(item.value)}</span>
                            </div>
                            <span style="font-size: 12px; color: #666;">n=${item.sample_size}</span>
                        </div>
                        <div class="signal-metrics">
                            <div class="signal-metric">
                                <span class="signal-metric-label">Avg Rank</span>
                                <span class="signal-metric-value">${item.avg_rank.toFixed(2)}</span>
                            </div>
                            <div class="signal-metric">
                                <span class="signal-metric-label">vs Median</span>
                                <span class="signal-metric-value ${item.vs_median_rank > 0 ? 'positive' : item.vs_median_rank < 0 ? 'negative' : ''}">
                                    ${item.vs_median_rank > 0 ? '+' : ''}${item.vs_median_rank.toFixed(2)}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayDistributionSummary(distributions) {
            const container = document.getElementById('distributionSummary');
            
            if (!distributions || distributions.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No distribution data available.</p></div>';
                return;
            }

            container.innerHTML = distributions.map(item => {
                return `
                    <div class="signal-card">
                        <div class="signal-header">
                            <div>
                                <span class="signal-feature">${escapeHtml(item.feature)}</span>
                                <span class="signal-value">: ${escapeHtml(item.value)}</span>
                            </div>
                            <span style="font-size: 12px; color: #666;">n=${item.count}</span>
                        </div>
                        <div class="signal-metrics">
                            <div class="signal-metric">
                                <span class="signal-metric-label">Median Views (Relative)</span>
                                <span class="signal-metric-value">${item.median_views_relative.toFixed(2)}</span>
                            </div>
                            <div class="signal-metric">
                                <span class="signal-metric-label">Median Engagement</span>
                                <span class="signal-metric-value">${item.median_engagement_proxy.toFixed(3)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleSection(header) {
            header.classList.toggle('expanded');
            const content = header.nextElementSibling;
            content.classList.toggle('expanded');
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Load analysis on page load
        loadAnalysis();
    </script>
</body>
</html>
