<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Analytics</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <style>
        .analysis-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .refresh-btn {
            padding: 10px 20px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .refresh-btn:hover {
            background-color: #555;
        }
        
        .refresh-btn:disabled {
            background-color: #999;
            cursor: not-allowed;
        }
        
        .loading-indicator {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .error-message {
            display: none;
            padding: 15px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            color: #721c24;
            margin-bottom: 20px;
        }
        
        .analysis-section {
            background-color: #fff;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 15px;
        }
        
        .analysis-section h2 {
            margin-top: 0;
            margin-bottom: 12px;
            color: #333;
            font-size: 20px;
        }
        
        .analysis-section h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #555;
            font-size: 16px;
        }
        
        .metadata-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .metadata-item {
            text-align: center;
        }
        
        .metadata-item strong {
            display: block;
            color: #666;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .metadata-item span {
            display: block;
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 13px;
        }
        
        .data-table th,
        .data-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        .video-comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 13px;
        }
        
        .video-comparison-table th,
        .video-comparison-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .video-comparison-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .video-comparison-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .video-comparison-table tr:last-child td {
            border-bottom: none;
        }
        
        .performance-rank {
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 3px;
            display: inline-block;
            font-size: 12px;
        }
        
        .performance-rank.high {
            background-color: #d4edda;
            color: #155724;
        }
        
        .performance-rank.medium {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .performance-rank.low {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .overlap-count {
            display: inline-block;
            padding: 2px 6px;
            background-color: #e7f3ff;
            color: #004085;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .traits-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .trait-tag {
            display: inline-block;
            padding: 2px 6px;
            background-color: #e9ecef;
            color: #495057;
            border-radius: 3px;
            font-size: 10px;
        }
        
        .trait-tag.overlap {
            background-color: #d4edda;
            color: #155724;
        }
        
        .trait-tag.unique {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .lift-value {
            font-weight: 600;
            font-size: 13px;
        }
        
        .lift-value.positive {
            color: #28a745;
        }
        
        .lift-value.negative {
            color: #dc3545;
        }
        
        .metric-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .metric-badge.positive {
            background-color: #d4edda;
            color: #155724;
        }
        
        .metric-badge.negative {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .metric-badge.neutral {
            background-color: #e9ecef;
            color: #495057;
        }
        
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 13px;
        }
        
        .collapsible-section {
            margin-top: 8px;
        }
        
        .collapsible-header {
            cursor: pointer;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .collapsible-header:hover {
            background-color: #e9ecef;
        }
        
        .collapsible-content {
            display: none;
            padding: 10px 0;
            margin-top: 8px;
        }
        
        .collapsible-content.expanded {
            display: block;
        }
        
        .toggle-icon {
            transition: transform 0.2s;
            font-size: 12px;
        }
        
        .collapsible-header.expanded .toggle-icon {
            transform: rotate(180deg);
        }
        
        .section-description {
            color: #6c757d;
            margin-bottom: 10px;
            font-size: 12px;
            font-style: italic;
        }
        
        .platform-header {
            margin: 12px 0 8px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .sample-size-link {
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
            font-weight: 600;
        }
        
        .sample-size-link:hover {
            color: #0056b3;
        }
        
        .sample-size-btn {
            margin-left: 6px;
            padding: 2px 6px;
            font-size: 10px;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 3px;
            cursor: pointer;
            color: #495057;
            display: inline-block;
        }
        
        .sample-size-btn:hover {
            background: #dee2e6;
        }
        
        .sample-size-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 220px;
            font-size: 12px;
        }
        
        .sample-size-container {
            position: relative;
            display: inline-block;
        }
        
        .sample-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 500px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .sample-popup.show {
            display: block;
        }
        
        .sample-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .sample-popup-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        
        .sample-popup-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sample-popup-close:hover {
            color: #333;
        }
        
        .sample-popup-content {
            font-size: 14px;
        }
        
        .sample-video-item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .sample-video-item:last-child {
            border-bottom: none;
        }
        
        .sample-video-item strong {
            color: #333;
        }
        
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
        }
        
        .popup-overlay.show {
            display: block;
        }
        
        .bucket-group {
            margin-bottom: 20px;
        }
        
        .bucket-group-header {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <nav>
        <a href="index.html">Instagram Insights</a>
        <a href="prerecording.html">Pre Recording</a>
        <a href="upload.html">Video Upload</a>
        <a href="videos.html">Videos</a>
        <a href="audio.html" class="active">Audio Analytics</a>
    </nav>

    <main>
        <div class="analysis-container">
            <div class="analysis-header">
                <h1>Performance Analytics</h1>
                <button id="refreshBtn" class="refresh-btn" onclick="loadAnalysis()">
                    üîÑ Refresh Data
                </button>
            </div>

            <div id="loading" class="loading-indicator">
                <p>Analyzing video performance data...</p>
            </div>

            <div id="error" class="error-message"></div>

            <div id="analysisContent" style="display: none;">
                <!-- Metadata Info -->
                <div class="analysis-section collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h2 style="margin: 0;">Analysis Overview</h2>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div id="metadataInfo" class="metadata-info"></div>
                    </div>
                </div>

                <!-- Early Signal Summary -->
                <div class="analysis-section collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h2 style="margin: 0;">Early Signal Summary</h2>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <p class="section-description">
                            Features showing directional signals (lift > 1.0 = positive). <em>Early signal only, not statistically validated.</em>
                        </p>
                        <div id="earlySignals"></div>
                    </div>
                </div>

                <!-- What Seems to Be Working -->
                <div class="analysis-section collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h2 style="margin: 0;">What Seems to Be Working</h2>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <p class="section-description">
                            Top-performing patterns ranked by lift and consistency with top 30% performers.
                        </p>
                        <div id="whatSeemsWorking"></div>
                    </div>
                </div>

                <!-- IG Per-Video Comparison -->
                <div class="analysis-section collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h2 style="margin: 0;">IG Per-Video Comparison</h2>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <p class="section-description">
                            Individual Instagram video performance with metadata overlap against top 30% performers.
                        </p>
                        <div id="perVideoComparisonIG"></div>
                    </div>
                </div>

                <!-- TikTok Per-Video Comparison -->
                <div class="analysis-section collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h2 style="margin: 0;">TikTok Per-Video Comparison</h2>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <p class="section-description">
                            Individual TikTok video performance with metadata overlap against top 30% performers.
                        </p>
                        <div id="perVideoComparisonTikTok"></div>
                    </div>
                </div>

                <!-- Rank Association -->
                <div class="analysis-section collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h2 style="margin: 0;">Rank Association Analysis</h2>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <p class="section-description">
                            Average performance rank by metadata value. Positive values indicate above-median performance.
                        </p>
                        <div id="rankAssociation"></div>
                    </div>
                </div>

                <!-- Distribution Summary -->
                <div class="analysis-section collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h2 style="margin: 0;">Distribution Summary</h2>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <p class="section-description">
                            Distribution statistics for each metadata feature.
                        </p>
                        <div id="distributionSummary"></div>
                    </div>
                </div>

                <!-- Charting Section -->
                <div class="analysis-section collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h2 style="margin: 0;">Charting</h2>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <p class="section-description">
                            Visual analysis of video performance metrics.
                        </p>
                        <div id="chartingContent">
                            <!-- Scatter Plots Row -->
                            <div style="display: flex; gap: 30px; margin-bottom: 40px;">
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 20px;">
                                        <label for="scatterFilterIG" style="font-weight: 600; margin-right: 10px; color: #495057;">Filter by Video Type:</label>
                                        <select id="scatterFilterIG" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; background: white; cursor: pointer;">
                                            <option value="All Videos">All Videos</option>
                                        </select>
                                    </div>
                                    <div id="artistFollowersScatter"></div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 20px;">
                                        <label for="scatterFilterTikTok" style="font-weight: 600; margin-right: 10px; color: #495057;">Filter by Video Type:</label>
                                        <select id="scatterFilterTikTok" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; background: white; cursor: pointer;">
                                            <option value="All Videos">All Videos</option>
                                        </select>
                                    </div>
                                    <div id="artistFollowersScatterTikTok"></div>
                                </div>
                            </div>
                            
                            <!-- Histograms Row -->
                            <div style="display: flex; gap: 30px;">
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                        <div>
                                            <label for="histogramFilter" style="font-weight: 600; margin-right: 10px; color: #495057;">Video Type:</label>
                                            <select id="histogramFilter" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; background: white; cursor: pointer;">
                                                <option value="All Videos">All Videos</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="histogramPlatformFilter" style="font-weight: 600; margin-right: 10px; color: #495057;">Platform:</label>
                                            <select id="histogramPlatformFilter" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; background: white; cursor: pointer;">
                                                <option value="Instagram" selected>Instagram</option>
                                                <option value="TikTok">TikTok</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="artistFollowersHistogram"></div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                        <div>
                                            <label for="histogramFilterPopularity" style="font-weight: 600; margin-right: 10px; color: #495057;">Video Type:</label>
                                            <select id="histogramFilterPopularity" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; background: white; cursor: pointer;">
                                                <option value="All Videos">All Videos</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="histogramPopularityPlatformFilter" style="font-weight: 600; margin-right: 10px; color: #495057;">Platform:</label>
                                            <select id="histogramPopularityPlatformFilter" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; background: white; cursor: pointer;">
                                                <option value="Instagram" selected>Instagram</option>
                                                <option value="TikTok">TikTok</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="popularityHistogram"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        async function loadAnalysis() {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const contentDiv = document.getElementById('analysisContent');
            const refreshBtn = document.getElementById('refreshBtn');

            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            contentDiv.style.display = 'none';
            refreshBtn.disabled = true;
            refreshBtn.textContent = '‚è≥ Loading...';

            try {
                const response = await fetch('/api/performance-analysis');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                loadingDiv.style.display = 'none';
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'üîÑ Refresh Data';

                if (data.error) {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = data.error;
                    return;
                }

                // Display the analysis results
                displayAnalysis(data);
                contentDiv.style.display = 'block';

            } catch (err) {
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = `Error loading analysis: ${err.message}`;
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'üîÑ Refresh Data';
                console.error('Error loading analysis:', err);
            }
        }

        function displayAnalysis(data) {
            // Display metadata info
            displayMetadataInfo(data.analysis_metadata);
            
            // Display early signals
            displayEarlySignals(data.early_signal_summary);
            
            // Display what seems working
            displayWhatSeemsWorking(data.what_seems_working);
            
            // Display per-video comparison
            // Split into IG and TikTok sections
            // Note: Videos with both platforms will appear in IG section (as per analysis logic)
            const igVideos = (data.per_video_comparison || []).filter(v => {
                const platform = (v.platform || '').toLowerCase();
                return platform === 'instagram';
            });
            const tiktokVideos = (data.per_video_comparison || []).filter(v => {
                const platform = (v.platform || '').toLowerCase();
                return platform === 'tiktok';
            });
            displayPerVideoComparisonIG(igVideos);
            displayPerVideoComparisonTikTok(tiktokVideos);
            
            // Display rank association
            displayRankAssociation(data.rank_association);
            
            // Display distribution summary
            displayDistributionSummary(data.distribution_summary);
            
            // Load and display charts
            loadChartingData();
        }

        function displayMetadataInfo(metadata) {
            const container = document.getElementById('metadataInfo');
            if (!metadata) {
                container.innerHTML = '<p>No metadata available</p>';
                return;
            }

            container.innerHTML = `
                <div class="metadata-item">
                    <strong>Total Videos</strong>
                    <span>${metadata.total_videos || 0}</span>
                </div>
                <div class="metadata-item">
                    <strong>Videos with Metrics</strong>
                    <span>${metadata.videos_with_metrics || 0}</span>
                </div>
                <div class="metadata-item">
                    <strong>Confidence Level</strong>
                    <span>${metadata.confidence_level || 'early_signal'}</span>
                </div>
                <div class="metadata-item">
                    <strong>Analysis Date</strong>
                    <span>${metadata.analysis_date ? formatDate(metadata.analysis_date) : 'N/A'}</span>
                </div>
            `;
        }

        function displayEarlySignals(signals) {
            const container = document.getElementById('earlySignals');
            
            if (!signals || signals.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No early signals found. Need more data with metrics.</p></div>';
                return;
            }

            // Calculate average lift for sorting
            const signalsWithAvgLift = signals.map(signal => ({
                ...signal,
                avgLift: (signal.lift_views + signal.lift_likes) / 2
            }));

            // Get top 10 overall
            const top10 = [...signalsWithAvgLift]
                .sort((a, b) => b.avgLift - a.avgLift)
                .slice(0, 10);

            // Group remaining signals by feature type
            const featureGroups = new Map();
            signalsWithAvgLift.forEach(signal => {
                if (!top10.find(t => t.feature === signal.feature && t.value === signal.value)) {
                    if (!featureGroups.has(signal.feature)) {
                        featureGroups.set(signal.feature, []);
                    }
                    featureGroups.get(signal.feature).push(signal);
                }
            });

            // Sort each group by average lift
            featureGroups.forEach((group, feature) => {
                group.sort((a, b) => b.avgLift - a.avgLift);
            });

            let html = '';

            // Top 10 Overall Section
            if (top10.length > 0) {
                html += `
                    <div class="bucket-group">
                        <div class="bucket-group-header">üèÜ Top 10 Overall Signals</div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Feature</th>
                                    <th>Value</th>
                                    <th>Range</th>
                                    <th>Sample Size</th>
                                    <th>Views Lift</th>
                                    <th>Likes Lift</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top10.map((signal, index) => renderSignalRow(signal, index)).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Grouped by Feature Type
            if (featureGroups.size > 0) {
                html += '<div style="margin-top: 25px;"><h3 style="font-size: 18px; margin-bottom: 15px; color: #495057;">Grouped by Feature Type</h3></div>';
                
                // Sort feature groups by name
                const sortedFeatures = Array.from(featureGroups.keys()).sort();
                
                sortedFeatures.forEach(feature => {
                    const group = featureGroups.get(feature);
                    if (group.length > 0) {
                        html += `
                            <div class="bucket-group">
                                <div class="bucket-group-header">${escapeHtml(feature)}</div>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Value</th>
                                            <th>Range</th>
                                            <th>Sample Size</th>
                                            <th>Views Lift</th>
                                            <th>Likes Lift</th>
                                            <th>Confidence</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${group.map((signal, index) => renderSignalRow(signal, index, true)).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                });
            }

            container.innerHTML = html;
        }

        function renderSampleSizeWithDropdown(sampleSize, videos, id, feature, value) {
            const videosList = videos && videos.length > 0
                ? videos.map(v => `
                    <div style="padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
                        <strong>${escapeHtml(v.trackName)}</strong> by ${escapeHtml(v.artistName)}
                    </div>
                `).join('')
                : '<div style="padding: 4px 0;">No video information available</div>';
            
            const featureEscaped = escapeHtml(feature);
            const valueEscaped = escapeHtml(value);
            
            return `
                <div class="sample-size-container" 
                     onmouseenter="showSampleDropdown('${id}')" 
                     onmouseleave="hideSampleDropdown('${id}')">
                    ${sampleSize}
                    <button class="sample-size-btn" 
                            style="margin-left: 6px; padding: 2px 6px; font-size: 10px; background: #e9ecef; border: 1px solid #ced4da; border-radius: 3px; cursor: pointer; color: #495057;">‚ÑπÔ∏è</button>
                    <div id="sample-dropdown-${id}" 
                         class="sample-size-dropdown" 
                         style="display: none; position: absolute; top: 100%; left: 0; margin-top: 4px; background: white; border: 1px solid #ced4da; border-radius: 4px; padding: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); z-index: 1000; min-width: 220px; font-size: 12px;">
                        <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 600;">Sample Videos</h4>
                        <div style="font-size: 11px; line-height: 1.5; margin-bottom: 6px; color: #666;">
                            <strong>Feature:</strong> ${featureEscaped}<br>
                            <strong>Value:</strong> ${valueEscaped}
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e9ecef;">
                            <strong style="color: #333;">Songs in Sample (${sampleSize}):</strong>
                            <div style="margin-top: 6px; max-height: 200px; overflow-y: auto;">
                                ${videosList}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSignalRow(signal, index, hideFeature = false) {
            const viewsLiftClass = signal.lift_views > 1.0 ? 'positive' : signal.lift_views < 1.0 ? 'negative' : '';
            const likesLiftClass = signal.lift_likes > 1.0 ? 'positive' : signal.lift_likes < 1.0 ? 'negative' : '';
            const bucketRange = signal.bucket_range ? escapeHtml(signal.bucket_range) : '‚Äî';
            const signalId = `signal-${signal.feature}-${signal.value}-${index}`.replace(/[^a-zA-Z0-9-]/g, '-');
            const videosJson = JSON.stringify(signal.videos || []).replace(/"/g, '&quot;');
            const featureEscaped = escapeHtml(signal.feature);
            const valueEscaped = escapeHtml(signal.value);
            
            const featureCell = hideFeature ? '' : `<td><strong>${featureEscaped}</strong></td>`;
            
            return `
                <tr>
                    ${featureCell}
                    <td>${valueEscaped}</td>
                    <td style="color: #6c757d; font-size: 11px;">${bucketRange}</td>
                    <td>
                        ${renderSampleSizeWithDropdown(signal.sample_size, signal.videos, signalId, signal.feature, signal.value)}
                    </td>
                    <td><span class="lift-value ${viewsLiftClass}">${signal.lift_views.toFixed(2)}x</span></td>
                    <td><span class="lift-value ${likesLiftClass}">${signal.lift_likes.toFixed(2)}x</span></td>
                    <td>${signal.confidence || 'early'}</td>
                </tr>
            `;
        }

        let sampleDropdownTimeout = null;

        function showSampleDropdown(id) {
            // Clear any pending hide timeout
            if (sampleDropdownTimeout) {
                clearTimeout(sampleDropdownTimeout);
                sampleDropdownTimeout = null;
            }
            
            const dropdown = document.getElementById(`sample-dropdown-${id}`);
            if (dropdown) {
                // Close all other dropdowns
                document.querySelectorAll('.sample-size-dropdown').forEach(dd => {
                    if (dd.id !== `sample-dropdown-${id}`) {
                        dd.style.display = 'none';
                    }
                });
                // Show this dropdown
                dropdown.style.display = 'block';
            }
        }

        function hideSampleDropdown(id) {
            // Small delay to allow moving mouse to dropdown
            sampleDropdownTimeout = setTimeout(() => {
                const dropdown = document.getElementById(`sample-dropdown-${id}`);
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
                sampleDropdownTimeout = null;
            }, 150);
        }

        function displayWhatSeemsWorking(working) {
            const container = document.getElementById('whatSeemsWorking');
            
            if (!working || working.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No clear patterns identified yet.</p></div>';
                return;
            }

            // Group results by platform
            const instagramResults = [];
            const tiktokResults = [];
            const generalResults = [];

            working.forEach(item => {
                if (item.feature === 'ig_hashtag') {
                    instagramResults.push(item);
                } else if (item.feature === 'tiktok_hashtag') {
                    tiktokResults.push(item);
                } else {
                    generalResults.push(item);
                }
            });

            // Helper function to render a table section
            function renderTableSection(items, title) {
                if (items.length === 0) return '';
                
                return `
                    <div style="margin-bottom: 15px;">
                        <div class="platform-header">${title}</div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Feature</th>
                                    <th>Value</th>
                                    <th>Range</th>
                                    <th>Sample</th>
                                    <th>Views Lift</th>
                                    <th>Likes Lift</th>
                                    <th>Top 30%</th>
                                    <th>Consistency</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map((item, index) => {
                                    const viewsLiftClass = item.lift_views > 1.0 ? 'positive' : 'negative';
                                    const likesLiftClass = item.lift_likes > 1.0 ? 'positive' : 'negative';
                                    const bucketRange = item.bucket_range ? escapeHtml(item.bucket_range) : '‚Äî';
                                    const signalId = `working-${item.feature}-${item.value}-${index}`.replace(/[^a-zA-Z0-9-]/g, '-');
                                    
                                    return `
                                        <tr>
                                            <td><strong>${escapeHtml(item.feature)}</strong></td>
                                            <td>${escapeHtml(item.value)}</td>
                                            <td style="color: #6c757d; font-size: 11px;">${bucketRange}</td>
                                            <td>
                                                ${renderSampleSizeWithDropdown(item.sample_size, item.videos, signalId, item.feature, item.value)}
                                            </td>
                                            <td><span class="lift-value ${viewsLiftClass}">${item.lift_views.toFixed(2)}x</span></td>
                                            <td><span class="lift-value ${likesLiftClass}">${item.lift_likes.toFixed(2)}x</span></td>
                                            <td>${item.appearances_in_top_30_percent || 0}</td>
                                            <td>${(item.consistency_score || 0).toFixed(2)}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Build HTML with grouped sections
            let html = '';
            html += renderTableSection(instagramResults, 'üì∑ Instagram-Specific');
            html += renderTableSection(tiktokResults, 'üéµ TikTok-Specific');
            html += renderTableSection(generalResults, 'üìä General Information');

            // If all sections are empty, show empty state
            if (html === '') {
                html = '<div class="empty-state"><p>No clear patterns identified yet.</p></div>';
            }

            container.innerHTML = html;
        }

        function displayPerVideoComparison(videos) {
            // This function is kept for backward compatibility but is no longer used
            // The data is now split into IG and TikTok sections
        }

        function displayPerVideoComparisonIG(videos) {
            const container = document.getElementById('perVideoComparisonIG');
            
            if (!videos || videos.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No Instagram video comparison data available.</p></div>';
                return;
            }

            renderPerVideoComparisonTable(videos, container);
        }

        function displayPerVideoComparisonTikTok(videos) {
            const container = document.getElementById('perVideoComparisonTikTok');
            
            if (!videos || videos.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No TikTok video comparison data available.</p></div>';
                return;
            }

            renderPerVideoComparisonTable(videos, container);
        }

        function renderPerVideoComparisonTable(videos, container) {
            if (!videos || videos.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No video comparison data available.</p></div>';
                return;
            }

            const tableHTML = `
                <table class="video-comparison-table">
                    <thead>
                        <tr>
                            <th>Video</th>
                            <th>Performance Rank</th>
                            <th>Views</th>
                            <th>Likes</th>
                            <th>Engagement</th>
                            <th>Overlap Count</th>
                            <th>Traits</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${videos.map(video => {
                            // Lower rank is better (rank 1 is best), so invert the logic
                            const rankClass = video.performance_rank <= 3 ? 'high' : video.performance_rank <= 6 ? 'medium' : 'low';
                            const overlapTraits = video.metadata_overlap_with_top_30_percent?.traits || [];
                            const uniqueTraits = video.unique_traits || [];
                            
                            return `
                                <tr>
                                    <td>
                                        <strong>${escapeHtml(video.trackName)}</strong><br>
                                        <small style="color: #666;">${escapeHtml(video.artistName)}</small>
                                    </td>
                                    <td>
                                        <div style="position: relative;">
                                            <span class="performance-rank ${rankClass}">
                                                ${video.performance_rank.toFixed(2)}
                                            </span>
                                            ${video.ranking_breakdown ? `
                                                <button class="ranking-details-btn" onclick="toggleRankingDetails('${video.s3Key}')" style="margin-left: 6px; padding: 2px 6px; font-size: 10px; background: #e9ecef; border: 1px solid #ced4da; border-radius: 3px; cursor: pointer; color: #495057;">‚ÑπÔ∏è</button>
                                                <div id="ranking-details-${video.s3Key}" class="ranking-details-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 4px; background: white; border: 1px solid #ced4da; border-radius: 4px; padding: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); z-index: 1000; min-width: 220px; font-size: 12px;">
                                                    <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 600;">Ranking Breakdown</h4>
                                                    <div style="font-size: 11px; line-height: 1.5;">
                                                        <div><strong>Views Rank:</strong> ${video.ranking_breakdown.views_rank} (${(video.ranking_breakdown.views || 0).toLocaleString()} views)</div>
                                                        <div><strong>Likes Rank:</strong> ${video.ranking_breakdown.likes_rank} (${(video.ranking_breakdown.likes || 0).toLocaleString()} likes)</div>
                                                        <div><strong>Engagement Rank:</strong> ${video.ranking_breakdown.engagement_rank} (${(video.ranking_breakdown.engagement_proxy || 0).toFixed(3)} ratio)</div>
                                                        <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e9ecef;">
                                                            <strong>Composite Rank:</strong> ${video.performance_rank.toFixed(2)}<br>
                                                            <small style="color: #6c757d; font-size: 10px;">Average of the three ranks above</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </td>
                                    <td>${(video.views || 0).toLocaleString()}</td>
                                    <td>${(video.likes || 0).toLocaleString()}</td>
                                    <td>${(video.engagement_proxy || 0).toFixed(3)}</td>
                                    <td>
                                        <span class="overlap-count">${overlapTraits.length}</span>
                                    </td>
                                    <td>
                                        <div class="traits-list">
                                            ${overlapTraits.map(t => `
                                                <span class="trait-tag overlap" title="${escapeHtml(t.feature)}: ${escapeHtml(t.value)}">
                                                    ${escapeHtml(t.feature.substring(0, 15))}
                                                </span>
                                            `).join('')}
                                            ${uniqueTraits.slice(0, 3).map(t => `
                                                <span class="trait-tag unique" title="${escapeHtml(t.feature)}: ${escapeHtml(t.value)}">
                                                    ${escapeHtml(t.feature.substring(0, 15))}
                                                </span>
                                            `).join('')}
                                            ${uniqueTraits.length > 3 ? `<span class="trait-tag">+${uniqueTraits.length - 3} more</span>` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        function displayRankAssociation(ranks) {
            const container = document.getElementById('rankAssociation');
            
            if (!ranks || ranks.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No rank association data available.</p></div>';
                return;
            }

            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Value</th>
                            <th>Sample Size</th>
                            <th>Avg Rank</th>
                            <th>vs Median</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${ranks.slice(0, 30).map((item, index) => {
                            const vsMedianClass = item.vs_median_rank > 0 ? 'positive' : item.vs_median_rank < 0 ? 'negative' : 'neutral';
                            const vsMedianSign = item.vs_median_rank > 0 ? '+' : '';
                            const signalId = `rank-${item.feature}-${item.value}-${index}`.replace(/[^a-zA-Z0-9-]/g, '-');
                            
                            return `
                                <tr>
                                    <td><strong>${escapeHtml(item.feature)}</strong></td>
                                    <td>${escapeHtml(item.value)}</td>
                                    <td>
                                        ${renderSampleSizeWithDropdown(item.sample_size, item.videos, signalId, item.feature, item.value)}
                                    </td>
                                    <td>${item.avg_rank.toFixed(2)}</td>
                                    <td><span class="metric-badge ${vsMedianClass}">${vsMedianSign}${item.vs_median_rank.toFixed(2)}</span></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        function displayDistributionSummary(distributions) {
            const container = document.getElementById('distributionSummary');
            
            if (!distributions || distributions.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No distribution data available.</p></div>';
                return;
            }

            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Value</th>
                            <th>Count</th>
                            <th>Median Views (Relative)</th>
                            <th>Median Engagement</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${distributions.map((item, index) => {
                            const signalId = `dist-${item.feature}-${item.value}-${index}`.replace(/[^a-zA-Z0-9-]/g, '-');
                            
                            return `
                                <tr>
                                    <td><strong>${escapeHtml(item.feature)}</strong></td>
                                    <td>${escapeHtml(item.value)}</td>
                                    <td>
                                        ${renderSampleSizeWithDropdown(item.count, item.videos, signalId, item.feature, item.value)}
                                    </td>
                                    <td>${item.median_views_relative.toFixed(2)}</td>
                                    <td>${item.median_engagement_proxy.toFixed(3)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        function toggleSection(header) {
            header.classList.toggle('expanded');
            const content = header.nextElementSibling;
            content.classList.toggle('expanded');
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function toggleRankingDetails(s3Key) {
            const dropdown = document.getElementById(`ranking-details-${s3Key}`);
            if (dropdown) {
                const isVisible = dropdown.style.display !== 'none';
                // Close all other dropdowns
                document.querySelectorAll('.ranking-details-dropdown').forEach(dd => {
                    dd.style.display = 'none';
                });
                // Toggle this one
                dropdown.style.display = isVisible ? 'none' : 'block';
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.ranking-details-btn') && !event.target.closest('.ranking-details-dropdown')) {
                document.querySelectorAll('.ranking-details-dropdown').forEach(dd => {
                    dd.style.display = 'none';
                });
            }
        });

        // Load charting data
        let allChartingVideos = [];
        
        async function loadChartingData() {
            try {
                // Fetch videos data for charting
                const response = await fetch('/api/videos');
                if (!response.ok) {
                    throw new Error('Failed to fetch videos data');
                }
                const videos = await response.json();
                allChartingVideos = videos;
                
                // Populate video type filters
                populateVideoTypeFilters(videos);
                
                // Display charts with default filter (Solo Mix)
                updateCharts();
            } catch (err) {
                console.error('Error loading charting data:', err);
                const scatterContainer = document.getElementById('artistFollowersScatter');
                const histogramContainer = document.getElementById('artistFollowersHistogram');
                const scatterTikTokContainer = document.getElementById('artistFollowersScatterTikTok');
                const popularityHistogramContainer = document.getElementById('popularityHistogram');
                const errorMessage = `<div class="empty-state"><p>Error loading chart data: ${err.message}</p></div>`;
                if (scatterContainer) {
                    scatterContainer.innerHTML = errorMessage;
                }
                if (histogramContainer) {
                    histogramContainer.innerHTML = errorMessage;
                }
                if (scatterTikTokContainer) {
                    scatterTikTokContainer.innerHTML = errorMessage;
                }
                if (popularityHistogramContainer) {
                    popularityHistogramContainer.innerHTML = errorMessage;
                }
            }
        }

        // Track if listeners have been added to avoid duplicates
        let filtersInitialized = false;
        
        function populateVideoTypeFilters(videos) {
            // Get unique video types
            const videoTypes = new Set();
            videos.forEach(v => {
                if (v.videoType) {
                    videoTypes.add(v.videoType);
                }
            });
            
            const sortedTypes = Array.from(videoTypes).sort();
            const options = '<option value="All Videos">All Videos</option>' + 
                sortedTypes.map(type => `<option value="${escapeHtml(type)}" ${type === 'Solo Mix' ? 'selected' : ''}>${escapeHtml(type)}</option>`).join('');
            
            // Populate all four filters (check if they exist first)
            const scatterFilterIG = document.getElementById('scatterFilterIG');
            const histogramFilter = document.getElementById('histogramFilter');
            const scatterFilterTikTok = document.getElementById('scatterFilterTikTok');
            const histogramFilterPopularity = document.getElementById('histogramFilterPopularity');
            
            if (!scatterFilterIG || !histogramFilter || !scatterFilterTikTok || !histogramFilterPopularity) {
                console.error('Chart filter elements not found. Charting section may not be loaded yet.');
                return;
            }
            
            scatterFilterIG.innerHTML = options;
            histogramFilter.innerHTML = options;
            scatterFilterTikTok.innerHTML = options;
            histogramFilterPopularity.innerHTML = options;
            
            // Add event listeners only once
            if (!filtersInitialized) {
                scatterFilterIG.addEventListener('change', updateCharts);
                histogramFilter.addEventListener('change', updateCharts);
                scatterFilterTikTok.addEventListener('change', updateCharts);
                histogramFilterPopularity.addEventListener('change', updateCharts);
                document.getElementById('histogramPlatformFilter')?.addEventListener('change', updateCharts);
                document.getElementById('histogramPopularityPlatformFilter')?.addEventListener('change', updateCharts);
                filtersInitialized = true;
            }
        }
        
        function filterVideosByType(videos, videoType) {
            if (videoType === 'All Videos') {
                return videos;
            }
            return videos.filter(v => v.videoType === videoType);
        }
        
        function updateCharts() {
            try {
                if (!allChartingVideos || allChartingVideos.length === 0) {
                    console.warn('No charting videos available');
                    return;
                }
                
                const scatterFilterIG = document.getElementById('scatterFilterIG')?.value || 'Solo Mix';
                const histogramFilter = document.getElementById('histogramFilter')?.value || 'Solo Mix';
                const scatterFilterTikTok = document.getElementById('scatterFilterTikTok')?.value || 'Solo Mix';
                const histogramFilterPopularity = document.getElementById('histogramFilterPopularity')?.value || 'Solo Mix';
                const histogramPlatformFilter = document.getElementById('histogramPlatformFilter')?.value || 'Instagram';
                const histogramPopularityPlatformFilter = document.getElementById('histogramPopularityPlatformFilter')?.value || 'Instagram';
                
                // Filter videos for each chart
                const scatterVideosIG = filterVideosByType(allChartingVideos, scatterFilterIG);
                const histogramVideos = filterVideosByType(allChartingVideos, histogramFilter);
                const histogramVideosPopularity = filterVideosByType(allChartingVideos, histogramFilterPopularity);
                const scatterVideosTikTok = filterVideosByType(allChartingVideos, scatterFilterTikTok);
                
                // Display charts
                displayArtistFollowersScatter(scatterVideosIG);
                displayArtistFollowersHistogram(histogramVideos, histogramPlatformFilter);
                displayPopularityHistogram(histogramVideosPopularity, histogramPopularityPlatformFilter);
                displayArtistFollowersScatterTikTok(scatterVideosTikTok);
            } catch (err) {
                console.error('Error updating charts:', err);
                const errorMessage = `<div class="empty-state"><p>Error displaying charts: ${err.message}</p></div>`;
                const containers = ['artistFollowersScatter', 'artistFollowersHistogram', 'popularityHistogram', 'artistFollowersScatterTikTok'];
                containers.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) {
                        container.innerHTML = errorMessage;
                    }
                });
            }
        }
        
        function displayArtistFollowersScatter(videos) {
            const container = document.getElementById('artistFollowersScatter');
            if (!container) {
                console.error('artistFollowersScatter container not found');
                return;
            }
            
            if (!videos || !Array.isArray(videos)) {
                container.innerHTML = '<div class="empty-state"><p>No video data available for Instagram scatter chart.</p></div>';
                return;
            }
            
            // Filter videos with both artistFollowers and IG views data
            const validVideos = videos.filter(v => 
                v && 
                v.artistFollowers !== null && 
                v.artistFollowers !== undefined && 
                v.igViews > 0
            );
            
            if (validVideos.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No data available for Instagram scatter chart.</p></div>';
                return;
            }
            
            // Get data points (followers on x-axis, IG views on y-axis)
            const dataPoints = validVideos.map(v => ({
                followers: v.artistFollowers,
                views: v.igViews,
                trackName: v.trackName || 'Unknown',
                artistName: v.artistName || 'Unknown'
            }));
            
            // Find max for scaling (min is always 0)
            const minFollowers = 0;
            const maxFollowers = dataPoints.length > 0 ? Math.max(...dataPoints.map(d => d.followers), 1) : 1;
            const minViews = 0;
            const maxViews = dataPoints.length > 0 ? Math.max(...dataPoints.map(d => d.views), 1) : 1;
            
            // Chart dimensions (adjusted for side-by-side layout)
            const chartWidth = 600;
            const chartHeight = 400;
            const marginLeft = 80;
            const marginRight = 50;
            const marginTop = 30;
            const marginBottom = 60;
            const plotWidth = chartWidth - marginLeft - marginRight;
            const plotHeight = chartHeight - marginTop - marginBottom;
            
            // Scale functions (min is always 0)
            const scaleX = (followers) => {
                if (maxFollowers === 0) return plotWidth / 2;
                return (followers / maxFollowers) * plotWidth;
            };
            
            const scaleY = (views) => {
                if (maxViews === 0) return plotHeight / 2;
                return plotHeight - (views / maxViews) * plotHeight;
            };
            
            // Get current filter value for title
            const filterValue = document.getElementById('scatterFilterIG')?.value || 'Solo Mix';
            const filterText = filterValue === 'All Videos' ? '' : ` (${filterValue})`;
            
            // Create scatter plot
            let svg = `
                <div style="margin-top: 15px;">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: #495057;">Artist Followers vs Instagram Views${filterText} (Scatter Plot)</h3>
                    <svg width="${chartWidth}" height="${chartHeight}" style="border: 1px solid #e9ecef; background: #fff;">
                        <!-- Y-axis label -->
                        <text x="${marginLeft / 2}" y="${marginTop + plotHeight / 2}" transform="rotate(-90, ${marginLeft / 2}, ${marginTop + plotHeight / 2})" 
                              style="font-size: 12px; fill: #666; text-anchor: middle;">Views</text>
                        
                        <!-- X-axis label -->
                        <text x="${marginLeft + plotWidth / 2}" y="${chartHeight - 10}" 
                              style="font-size: 12px; fill: #666; text-anchor: middle;">Artist Followers</text>
                        
                        <!-- X-axis -->
                        <line x1="${marginLeft}" y1="${marginTop + plotHeight}" 
                              x2="${marginLeft + plotWidth}" y2="${marginTop + plotHeight}" 
                              style="stroke: #333; stroke-width: 2;" />
                        
                        <!-- Y-axis -->
                        <line x1="${marginLeft}" y1="${marginTop}" 
                              x2="${marginLeft}" y2="${marginTop + plotHeight}" 
                              style="stroke: #333; stroke-width: 2;" />
                        
                        <!-- X-axis ticks and labels -->
                        ${[0, 0.25, 0.5, 0.75, 1.0].map((ratio, i) => {
                            const x = marginLeft + (ratio * plotWidth);
                            const value = Math.round(maxFollowers * ratio);
                            return `
                                <line x1="${x}" y1="${marginTop + plotHeight}" x2="${x}" y2="${marginTop + plotHeight + 5}" 
                                      style="stroke: #666; stroke-width: 1;" />
                                <text x="${x}" y="${marginTop + plotHeight + 20}" text-anchor="middle" 
                                      style="font-size: 11px; fill: #666;">${value.toLocaleString()}</text>
                            `;
                        }).join('')}
                        
                        <!-- Y-axis ticks and labels -->
                        ${[0, 0.25, 0.5, 0.75, 1.0].map((ratio, i) => {
                            const y = marginTop + plotHeight - (ratio * plotHeight);
                            const value = Math.round(maxViews * ratio);
                            return `
                                <line x1="${marginLeft - 5}" y1="${y}" x2="${marginLeft}" y2="${y}" 
                                      style="stroke: #666; stroke-width: 1;" />
                                <text x="${marginLeft - 10}" y="${y + 4}" text-anchor="end" 
                                      style="font-size: 11px; fill: #666;">${value.toLocaleString()}</text>
                            `;
                        }).join('')}
                        
                        <!-- Data points -->
                        ${dataPoints.map((point, index) => {
                            const x = marginLeft + scaleX(point.followers);
                            const y = marginTop + scaleY(point.views);
                            return `
                                <circle cx="${x}" cy="${y}" r="4" 
                                        style="fill: #007bff; stroke: #0056b3; stroke-width: 1; cursor: pointer;"
                                        onmouseover="showScatterTooltip(event, '${escapeHtml(point.trackName)}', '${escapeHtml(point.artistName)}', ${point.followers}, ${point.views})"
                                        onmouseout="hideScatterTooltip()" />
                            `;
                        }).join('')}
                    </svg>
                </div>
            `;
            
            container.innerHTML = svg;
        }

        function showScatterTooltip(event, trackName, artistName, followers, views) {
            let tooltip = document.getElementById('scatter-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'scatter-tooltip';
                tooltip.style.cssText = 'display: none; position: absolute; background: white; border: 1px solid #ccc; border-radius: 4px; padding: 6px; font-size: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10000; pointer-events: none;';
                document.body.appendChild(tooltip);
            }
            
            tooltip.innerHTML = `
                <strong>${trackName}</strong><br>
                ${artistName}<br>
                Followers: ${followers.toLocaleString()}<br>
                Views: ${views.toLocaleString()}
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        function hideScatterTooltip() {
            const tooltip = document.getElementById('scatter-tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }

        function displayArtistFollowersHistogram(videos, platformParam = 'Instagram') {
            const container = document.getElementById('artistFollowersHistogram');
            if (!container) return;
            
            // Ensure platform is always defined (handle undefined, null, empty string)
            let platform = platformParam;
            if (typeof platform === 'undefined' || platform === null || platform === '' || platform === 'undefined' || platform === 'null') {
                platform = 'Instagram';
            }
            
            // Filter videos with artistFollowers and views data based on platform (video type already filtered by updateCharts)
            const validVideos = videos.filter(v => {
                if (v.artistFollowers === null || v.artistFollowers === undefined) return false;
                if (platform === 'Instagram') {
                    return v.igViews > 0;
                } else {
                    return v.tiktokViews > 0;
                }
            });
            
            if (validVideos.length === 0) {
                const filterValue = document.getElementById('histogramFilter')?.value || 'Solo Mix';
                const platformText = platform === 'Instagram' ? 'Instagram' : 'TikTok';
                container.innerHTML = `<div class="empty-state"><p>No ${filterValue === 'All Videos' ? '' : filterValue + ' '}videos with ${platformText} views data available for histogram.</p></div>`;
                return;
            }
            
            // Get data points with both followers and popularity, using the selected platform's views
            const dataPoints = validVideos.map(v => ({
                followers: v.artistFollowers,
                popularity: v.popularity,
                views: platform === 'Instagram' ? v.igViews : v.tiktokViews
            }));
            
            // Create histogram bins for artist followers
            // Use predefined bins matching the artist_size buckets
            const followerBins = [
                { label: '< 100k', min: 0, max: 100000, data: [], type: 'followers' },
                { label: '100k-1M', min: 100000, max: 1000000, data: [], type: 'followers' },
                { label: '1M-3M', min: 1000000, max: 3000000, data: [], type: 'followers' },
                { label: '3M-10M', min: 3000000, max: 10000000, data: [], type: 'followers' },
                { label: '> 10M', min: 10000000, max: Infinity, data: [], type: 'followers' }
            ];
            
            // Create histogram bins for track popularity
            // Use predefined bins matching the track_popularity buckets
            const popularityBins = [
                { label: '<50', min: 0, max: 50, data: [], type: 'popularity' },
                { label: '51-70', min: 51, max: 70, data: [], type: 'popularity' },
                { label: '71-84', min: 71, max: 84, data: [], type: 'popularity' },
                { label: '>84', min: 85, max: 100, data: [], type: 'popularity' }
            ];
            
            // Sort data into follower bins
            dataPoints.forEach(point => {
                for (const bin of followerBins) {
                    if (point.followers >= bin.min && point.followers < bin.max) {
                        bin.data.push(point);
                        break;
                    }
                }
            });
            
            // Sort data into popularity bins
            dataPoints.forEach(point => {
                if (point.popularity !== null && point.popularity !== undefined) {
                    for (const bin of popularityBins) {
                        if (point.popularity >= bin.min && point.popularity <= bin.max) {
                            bin.data.push(point);
                            break;
                        }
                    }
                }
            });
            
            // Calculate average views per bin
            followerBins.forEach(bin => {
                if (bin.data.length > 0) {
                    bin.avgViews = bin.data.reduce((sum, d) => sum + d.views, 0) / bin.data.length;
                    bin.count = bin.data.length;
                } else {
                    bin.avgViews = 0;
                    bin.count = 0;
                }
            });
            
            popularityBins.forEach(bin => {
                if (bin.data.length > 0) {
                    bin.avgViews = bin.data.reduce((sum, d) => sum + d.views, 0) / bin.data.length;
                    bin.count = bin.data.length;
                } else {
                    bin.avgViews = 0;
                    bin.count = 0;
                }
            });
            
            // Find max for scaling (only follower bins for this chart)
            const maxAvgViews = Math.max(...followerBins.map(b => b.avgViews), 1);
            
            // Create histogram (only followers)
            const chartWidth = 600;
            const chartHeight = 400;
            const barWidth = 90;
            const barSpacing = 15;
            const maxBarHeight = 300;
            const startX = 80;
            const startY = 350;
            
            // Get current filter value for title
            const filterValue = document.getElementById('histogramFilter')?.value || 'Solo Mix';
            const filterText = filterValue === 'All Videos' ? '' : ` (${filterValue})`;
            const platformText = platform === 'Instagram' ? 'Instagram' : 'TikTok';
            
            let svg = `
                <div style="margin-top: 15px;">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: #495057;">Average ${platformText} Views by Artist Followers${filterText}</h3>
                    <svg width="${chartWidth}" height="${chartHeight}" style="border: 1px solid #e9ecef; background: #fff;">
                        <!-- Y-axis label -->
                        <text x="20" y="${startY / 2}" transform="rotate(-90, 20, ${startY / 2})" 
                              style="font-size: 12px; fill: #666;">Average ${platformText} Views</text>
                        
                        <!-- X-axis -->
                        <line x1="${startX}" y1="${startY}" x2="${chartWidth - 30}" y2="${startY}" 
                              style="stroke: #333; stroke-width: 2;" />
                        
                        <!-- Y-axis -->
                        <line x1="${startX}" y1="${startY}" x2="${startX}" y2="30" 
                              style="stroke: #333; stroke-width: 2;" />
                        
                        <!-- Y-axis ticks and labels -->
                        ${[0, 0.25, 0.5, 0.75, 1.0].map((ratio, i) => {
                            const y = startY - (ratio * maxBarHeight);
                            const value = Math.round(maxAvgViews * ratio);
                            return `
                                <line x1="${startX - 5}" y1="${y}" x2="${startX}" y2="${y}" 
                                      style="stroke: #666; stroke-width: 1;" />
                                <text x="${startX - 10}" y="${y + 4}" text-anchor="end" 
                                      style="font-size: 11px; fill: #666;">${value.toLocaleString()}</text>
                            `;
                        }).join('')}
            `;
            
            // Draw follower bars
            followerBins.forEach((bin, index) => {
                if (bin.count === 0) return;
                
                const x = startX + (index * (barWidth + barSpacing)) + barSpacing;
                const barHeight = (bin.avgViews / maxAvgViews) * maxBarHeight;
                const y = startY - barHeight;
                
                // Bar (blue for followers)
                svg += `
                    <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" 
                          style="fill: #007bff; stroke: #0056b3; stroke-width: 1;" />
                    <text x="${x + barWidth / 2}" y="${y - 5}" text-anchor="middle" 
                          style="font-size: 11px; font-weight: 600; fill: #333;">
                        ${Math.round(bin.avgViews).toLocaleString()}
                    </text>
                    <text x="${x + barWidth / 2}" y="${startY + 20}" text-anchor="middle" 
                          style="font-size: 11px; fill: #666;">
                        ${bin.label}
                    </text>
                    <text x="${x + barWidth / 2}" y="${startY + 35}" text-anchor="middle" 
                          style="font-size: 10px; fill: #999;">
                        (n=${bin.count})
                    </text>
                `;
            });
            
            svg += `
                    </svg>
                </div>
            `;
            
            container.innerHTML = svg;
        }

        function displayPopularityHistogram(videos, platformParam = 'Instagram') {
            const container = document.getElementById('popularityHistogram');
            if (!container) return;
            
            // Ensure platform is always defined (handle undefined, null, empty string)
            let platform = platformParam;
            if (typeof platform === 'undefined' || platform === null || platform === '' || platform === 'undefined' || platform === 'null') {
                platform = 'Instagram';
            }
            
            // Filter videos with popularity and views data based on platform (video type already filtered by updateCharts)
            const validVideos = videos.filter(v => {
                if (v.popularity === null || v.popularity === undefined) return false;
                if (platform === 'Instagram') {
                    return v.igViews > 0;
                } else {
                    return v.tiktokViews > 0;
                }
            });
            
            if (validVideos.length === 0) {
                const filterValue = document.getElementById('histogramFilterPopularity')?.value || 'Solo Mix';
                const platformText = platform === 'Instagram' ? 'Instagram' : 'TikTok';
                container.innerHTML = `<div class="empty-state"><p>No ${filterValue === 'All Videos' ? '' : filterValue + ' '}videos with ${platformText} views data available for popularity histogram.</p></div>`;
                return;
            }
            
            // Get data points using the selected platform's views
            const dataPoints = validVideos.map(v => ({
                popularity: v.popularity,
                views: platform === 'Instagram' ? v.igViews : v.tiktokViews
            }));
            
            // Create histogram bins for track popularity
            const popularityBins = [
                { label: '<50', min: 0, max: 50, data: [] },
                { label: '51-70', min: 51, max: 70, data: [] },
                { label: '71-84', min: 71, max: 84, data: [] },
                { label: '>84', min: 85, max: 100, data: [] }
            ];
            
            // Sort data into popularity bins
            dataPoints.forEach(point => {
                for (const bin of popularityBins) {
                    if (point.popularity >= bin.min && point.popularity <= bin.max) {
                        bin.data.push(point);
                        break;
                    }
                }
            });
            
            // Calculate average views per bin
            popularityBins.forEach(bin => {
                if (bin.data.length > 0) {
                    bin.avgViews = bin.data.reduce((sum, d) => sum + d.views, 0) / bin.data.length;
                    bin.count = bin.data.length;
                } else {
                    bin.avgViews = 0;
                    bin.count = 0;
                }
            });
            
            // Find max for scaling
            const maxAvgViews = Math.max(...popularityBins.map(b => b.avgViews), 1);
            
            // Create histogram
            const chartWidth = 600;
            const chartHeight = 400;
            const barWidth = 110;
            const barSpacing = 20;
            const maxBarHeight = 300;
            const startX = 80;
            const startY = 350;
            
            // Get current filter value for title
            const filterValue = document.getElementById('histogramFilterPopularity')?.value || 'Solo Mix';
            const filterText = filterValue === 'All Videos' ? '' : ` (${filterValue})`;
            const platformText = platform === 'Instagram' ? 'Instagram' : 'TikTok';
            
            let svg = `
                <div style="margin-top: 15px;">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: #495057;">Average ${platformText} Views by Song Popularity${filterText}</h3>
                    <svg width="${chartWidth}" height="${chartHeight}" style="border: 1px solid #e9ecef; background: #fff;">
                        <!-- Y-axis label -->
                        <text x="20" y="${startY / 2}" transform="rotate(-90, 20, ${startY / 2})" 
                              style="font-size: 12px; fill: #666;">Average ${platformText} Views</text>
                        
                        <!-- X-axis -->
                        <line x1="${startX}" y1="${startY}" x2="${chartWidth - 30}" y2="${startY}" 
                              style="stroke: #333; stroke-width: 2;" />
                        
                        <!-- Y-axis -->
                        <line x1="${startX}" y1="${startY}" x2="${startX}" y2="30" 
                              style="stroke: #333; stroke-width: 2;" />
                        
                        <!-- Y-axis ticks and labels -->
                        ${[0, 0.25, 0.5, 0.75, 1.0].map((ratio, i) => {
                            const y = startY - (ratio * maxBarHeight);
                            const value = Math.round(maxAvgViews * ratio);
                            return `
                                <line x1="${startX - 5}" y1="${y}" x2="${startX}" y2="${y}" 
                                      style="stroke: #666; stroke-width: 1;" />
                                <text x="${startX - 10}" y="${y + 4}" text-anchor="end" 
                                      style="font-size: 11px; fill: #666;">${value.toLocaleString()}</text>
                            `;
                        }).join('')}
            `;
            
            // Draw popularity bars
            popularityBins.forEach((bin, index) => {
                if (bin.count === 0) return;
                
                const x = startX + (index * (barWidth + barSpacing)) + barSpacing;
                const barHeight = (bin.avgViews / maxAvgViews) * maxBarHeight;
                const y = startY - barHeight;
                
                // Bar (green for popularity)
                svg += `
                    <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" 
                          style="fill: #28a745; stroke: #1e7e34; stroke-width: 1;" />
                    <text x="${x + barWidth / 2}" y="${y - 5}" text-anchor="middle" 
                          style="font-size: 11px; font-weight: 600; fill: #333;">
                        ${Math.round(bin.avgViews).toLocaleString()}
                    </text>
                    <text x="${x + barWidth / 2}" y="${startY + 20}" text-anchor="middle" 
                          style="font-size: 11px; fill: #666;">
                        ${bin.label}
                    </text>
                    <text x="${x + barWidth / 2}" y="${startY + 35}" text-anchor="middle" 
                          style="font-size: 10px; fill: #999;">
                        (n=${bin.count})
                    </text>
                `;
            });
            
            svg += `
                    </svg>
                </div>
            `;
            
            container.innerHTML = svg;
        }

        function displayArtistFollowersScatterTikTok(videos) {
            const container = document.getElementById('artistFollowersScatterTikTok');
            
            // Filter videos with both artistFollowers and TikTok views data
            const validVideos = videos.filter(v => 
                v.artistFollowers !== null && 
                v.artistFollowers !== undefined && 
                v.tiktokViews > 0
            );
            
            if (validVideos.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No data available for TikTok scatter chart.</p></div>';
                return;
            }
            
            // Get data points (followers on x-axis, TikTok views on y-axis)
            const dataPoints = validVideos.map(v => ({
                followers: v.artistFollowers,
                views: v.tiktokViews,
                trackName: v.trackName || 'Unknown',
                artistName: v.artistName || 'Unknown'
            }));
            
            // Find max for scaling (min is always 0)
            const minFollowers = 0;
            const maxFollowers = dataPoints.length > 0 ? Math.max(...dataPoints.map(d => d.followers), 1) : 1;
            const minViews = 0;
            const maxViews = dataPoints.length > 0 ? Math.max(...dataPoints.map(d => d.views), 1) : 1;
            
            // Chart dimensions (adjusted for side-by-side layout)
            const chartWidth = 600;
            const chartHeight = 400;
            const marginLeft = 80;
            const marginRight = 50;
            const marginTop = 30;
            const marginBottom = 60;
            const plotWidth = chartWidth - marginLeft - marginRight;
            const plotHeight = chartHeight - marginTop - marginBottom;
            
            // Scale functions (min is always 0)
            const scaleX = (followers) => {
                if (maxFollowers === 0) return plotWidth / 2;
                return (followers / maxFollowers) * plotWidth;
            };
            
            const scaleY = (views) => {
                if (maxViews === 0) return plotHeight / 2;
                return plotHeight - (views / maxViews) * plotHeight;
            };
            
            // Get current filter value for title
            const filterValue = document.getElementById('scatterFilterTikTok')?.value || 'Solo Mix';
            const filterText = filterValue === 'All Videos' ? '' : ` (${filterValue})`;
            
            // Create scatter plot
            let svg = `
                <div style="margin-top: 15px;">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: #495057;">Artist Followers vs TikTok Views${filterText} (Scatter Plot)</h3>
                    <svg width="${chartWidth}" height="${chartHeight}" style="border: 1px solid #e9ecef; background: #fff;">
                        <!-- Y-axis label -->
                        <text x="${marginLeft / 2}" y="${marginTop + plotHeight / 2}" transform="rotate(-90, ${marginLeft / 2}, ${marginTop + plotHeight / 2})" 
                              style="font-size: 12px; fill: #666; text-anchor: middle;">Views</text>
                        
                        <!-- X-axis label -->
                        <text x="${marginLeft + plotWidth / 2}" y="${chartHeight - 10}" 
                              style="font-size: 12px; fill: #666; text-anchor: middle;">Artist Followers</text>
                        
                        <!-- X-axis -->
                        <line x1="${marginLeft}" y1="${marginTop + plotHeight}" 
                              x2="${marginLeft + plotWidth}" y2="${marginTop + plotHeight}" 
                              style="stroke: #333; stroke-width: 2;" />
                        
                        <!-- Y-axis -->
                        <line x1="${marginLeft}" y1="${marginTop}" 
                              x2="${marginLeft}" y2="${marginTop + plotHeight}" 
                              style="stroke: #333; stroke-width: 2;" />
                        
                        <!-- X-axis ticks and labels -->
                        ${[0, 0.25, 0.5, 0.75, 1.0].map((ratio, i) => {
                            const x = marginLeft + (ratio * plotWidth);
                            const value = Math.round(maxFollowers * ratio);
                            return `
                                <line x1="${x}" y1="${marginTop + plotHeight}" x2="${x}" y2="${marginTop + plotHeight + 5}" 
                                      style="stroke: #666; stroke-width: 1;" />
                                <text x="${x}" y="${marginTop + plotHeight + 20}" text-anchor="middle" 
                                      style="font-size: 11px; fill: #666;">${value.toLocaleString()}</text>
                            `;
                        }).join('')}
                        
                        <!-- Y-axis ticks and labels -->
                        ${[0, 0.25, 0.5, 0.75, 1.0].map((ratio, i) => {
                            const y = marginTop + plotHeight - (ratio * plotHeight);
                            const value = Math.round(maxViews * ratio);
                            return `
                                <line x1="${marginLeft - 5}" y1="${y}" x2="${marginLeft}" y2="${y}" 
                                      style="stroke: #666; stroke-width: 1;" />
                                <text x="${marginLeft - 10}" y="${y + 4}" text-anchor="end" 
                                      style="font-size: 11px; fill: #666;">${value.toLocaleString()}</text>
                            `;
                        }).join('')}
                        
                        <!-- Data points -->
                        ${dataPoints.map((point, index) => {
                            const x = marginLeft + scaleX(point.followers);
                            const y = marginTop + scaleY(point.views);
                            return `
                                <circle cx="${x}" cy="${y}" r="4" 
                                        style="fill: #007bff; stroke: #0056b3; stroke-width: 1; cursor: pointer;"
                                        onmouseover="showScatterTooltip(event, '${escapeHtml(point.trackName)}', '${escapeHtml(point.artistName)}', ${point.followers}, ${point.views})"
                                        onmouseout="hideScatterTooltip()" />
                            `;
                        }).join('')}
                    </svg>
                </div>
            `;
            
            container.innerHTML = svg;
        }

        // Load analysis on page load
        loadAnalysis();
    </script>
</body>
</html>
