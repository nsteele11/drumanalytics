<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Videos</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>

<nav>
    <a href="index.html">Instagram Insights</a>
    <a href="prerecording.html">Pre Recording</a>
    <a href="upload.html">Video Upload</a>
    <a href="videos.html" class="active">Videos</a>
    <a href="audio.html">Audio Analytics</a>
</nav>

<main>
    <h1>Videos</h1>

    <div class="section-placeholder">
        <div id="loading" style="text-align: center; padding: 20px; display: none;">
            Loading videos...
        </div>
        
        <div id="error" style="display: none; padding: 15px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; color: #721c24; margin-bottom: 20px;">
        </div>

        <div id="videosContainer" class="videos-container">
            <!-- Videos will be inserted here -->
        </div>
    </div>
</main>

<script>
// Fetch and display videos
async function loadVideos() {
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const videosContainer = document.getElementById('videosContainer');

    loadingDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    videosContainer.innerHTML = '';

    try {
        const response = await fetch('/api/videos');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const videos = await response.json();
        loadingDiv.style.display = 'none';

        if (videos.length === 0) {
            videosContainer.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No videos uploaded yet.</p>';
            return;
        }

        // Display videos
        videos.forEach(video => {
            const videoCard = createVideoCard(video);
            videosContainer.appendChild(videoCard);
        });

    } catch (err) {
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
        errorDiv.textContent = `Error loading videos: ${err.message}`;
        console.error('Error loading videos:', err);
    }
}

function createVideoCard(video) {
    const card = document.createElement('div');
    card.className = 'video-card';

    // Format date
    const uploadDate = video.uploadTimestamp 
        ? new Date(video.uploadTimestamp).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        })
        : 'Unknown date';

    // Album cover or placeholder
    const albumCover = video.albumImageUrl 
        ? `<img src="${video.albumImageUrl}" alt="Album Cover" class="video-album-cover">`
        : '<div class="video-album-placeholder">No Cover</div>';

    // Video snapshot (will be loaded asynchronously)
    const videoSnapshot = video.snapshotKey
        ? `<img src="" alt="Video Snapshot" class="video-snapshot" data-snapshot-key="${escapeHtml(video.snapshotKey)}" style="display: none;">`
        : '';

    card.innerHTML = `
        <div class="video-card-content">
            <button class="delete-video-btn-x" data-s3key="${escapeHtml(video.s3Key)}" title="Delete video">
                √ó
            </button>
            <div class="video-album-section">
                ${albumCover}
                ${videoSnapshot}
            </div>
            <div class="video-info-section">
                <h3 class="video-track-name">${escapeHtml(video.trackName)}</h3>
                <p class="video-artist-name">${escapeHtml(video.artistName)}</p>
                
                <div class="video-metadata">
                    ${video.album ? `<div class="video-meta-item"><strong>Album:</strong> ${escapeHtml(video.album)}</div>` : ''}
                    ${video.popularity !== null ? `<div class="video-meta-item"><strong>Popularity:</strong> ${video.popularity}/100</div>` : ''}
                    ${video.artistFollowers !== null ? `<div class="video-meta-item"><strong>Artist Followers:</strong> ${video.artistFollowers.toLocaleString()}</div>` : ''}
                    ${video.genres && video.genres.length > 0 ? `<div class="video-meta-item"><strong>Genres:</strong> ${escapeHtml(video.genres.join(', '))}</div>` : ''}
                    ${video.duration ? `<div class="video-meta-item"><strong>Duration:</strong> ${formatDuration(video.duration)}</div>` : ''}
                    ${video.bpm ? `<div class="video-meta-item"><strong>BPM:</strong> ${video.bpm}</div>` : ''}
                    ${video.shockValue !== null ? `<div class="video-meta-item"><strong>Shock Value:</strong> <span style="font-weight: bold; color: ${getShockValueColor(video.shockValue)};">${video.shockValue}/100</span></div>` : ''}
                    
                    <!-- Social Media Metrics Section -->
                    <div class="social-metrics-section" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #333;">Social Media Metrics</h4>
                        ${video.igHashtags ? `<div class="video-meta-item"><strong>IG Hashtags:</strong> ${escapeHtml(video.igHashtags)}</div>` : ''}
                        ${video.tiktokHashtags ? `<div class="video-meta-item"><strong>TikTok Hashtags:</strong> ${escapeHtml(video.tiktokHashtags)}</div>` : ''}
                        ${video.igViews !== null ? `<div class="video-meta-item"><strong>IG Views:</strong> ${video.igViews.toLocaleString()}</div>` : ''}
                        ${video.igLikes !== null ? `<div class="video-meta-item"><strong>IG Likes:</strong> ${video.igLikes.toLocaleString()}</div>` : ''}
                        ${video.tiktokViews !== null ? `<div class="video-meta-item"><strong>TikTok Views:</strong> ${video.tiktokViews.toLocaleString()}</div>` : ''}
                        ${video.tiktokLikes !== null ? `<div class="video-meta-item"><strong>TikTok Likes:</strong> ${video.tiktokLikes.toLocaleString()}</div>` : ''}
                        ${video.metricsUpdatedAt ? `<div class="video-meta-item" style="font-size: 12px; color: #666; font-style: italic;"><strong>As of:</strong> ${formatDate(video.metricsUpdatedAt)}</div>` : ''}
                    </div>
                    
                    <div class="video-meta-item"><strong>Uploaded:</strong> ${uploadDate}</div>
                </div>

                <div class="video-actions">
                    <button class="play-video-btn" data-s3key="${escapeHtml(video.s3Key)}">
                        ‚ñ∂ Play Video
                    </button>
                    <button class="edit-metrics-btn" data-s3key="${escapeHtml(video.s3Key)}">
                        ‚úèÔ∏è Edit Metrics
                    </button>
                    <button class="suggest-hashtags-btn" data-s3key="${escapeHtml(video.s3Key)}">
                        Suggest #s
                    </button>
                </div>
            </div>
        </div>
    `;

    // Add click handler for play button
    const playBtn = card.querySelector('.play-video-btn');
    playBtn.addEventListener('click', async () => {
        await playVideo(video.s3Key, playBtn);
    });

    // Add click handler for edit button
    const editBtn = card.querySelector('.edit-metrics-btn');
    editBtn.addEventListener('click', () => {
        openEditMetricsModal(video, card);
    });

    // Add click handler for suggest hashtags button
    const suggestBtn = card.querySelector('.suggest-hashtags-btn');
    suggestBtn.addEventListener('click', async () => {
        await openHashtagSuggestionsModal(video);
    });

    // Add click handler for delete button (X in top right)
    const deleteBtn = card.querySelector('.delete-video-btn-x');
    deleteBtn.addEventListener('click', async () => {
        await deleteVideo(video.s3Key, card, video.trackName, video.artistName);
    });

    // Load snapshot image if available
    const snapshotImg = card.querySelector('.video-snapshot');
    if (snapshotImg && video.snapshotKey) {
        loadVideoSnapshot(video.s3Key, snapshotImg);
    }

    return card;
}

async function loadVideoSnapshot(s3Key, imgElement) {
    try {
        const response = await fetch(`/api/videos/${encodeURIComponent(s3Key)}/snapshot`);
        
        if (!response.ok) {
            console.warn(`Failed to get snapshot URL: ${response.status}`);
            return;
        }

        const data = await response.json();
        imgElement.src = data.url;
        imgElement.style.display = 'block';
    } catch (err) {
        console.error('Error loading snapshot:', err);
    }
}

async function playVideo(s3Key, button) {
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Loading...';

    try {
        const response = await fetch(`/api/videos/${encodeURIComponent(s3Key)}/play`);
        
        if (!response.ok) {
            throw new Error(`Failed to get video URL: ${response.status}`);
        }

        const data = await response.json();
        
        // Open video in new window/tab
        window.open(data.url, '_blank');
        
    } catch (err) {
        alert(`Error loading video: ${err.message}`);
        console.error('Error playing video:', err);
    } finally {
        button.disabled = false;
        button.textContent = originalText;
    }
}

async function deleteVideo(s3Key, cardElement, trackName, artistName) {
    // Confirm deletion
    const confirmMessage = `Are you sure you want to delete "${trackName}" by ${artistName}? This will permanently delete the video and all related data.`;
    
    if (!confirm(confirmMessage)) {
        return;
    }

    const deleteBtn = cardElement.querySelector('.delete-video-btn-x');
    if (deleteBtn) {
        deleteBtn.disabled = true;
        deleteBtn.textContent = '...';
    }

    try {
        const response = await fetch(`/api/videos/${encodeURIComponent(s3Key)}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `Failed to delete video: ${response.status}`);
        }

        const data = await response.json();
        console.log('Video deleted:', data);
        
        // Remove the card from the DOM with a fade-out effect
        cardElement.style.transition = 'opacity 0.3s ease';
        cardElement.style.opacity = '0';
        
        setTimeout(() => {
            cardElement.remove();
            
            // Check if no videos left
            const videosContainer = document.getElementById('videosContainer');
            if (videosContainer.children.length === 0) {
                videosContainer.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No videos uploaded yet.</p>';
            }
        }, 300);
        
    } catch (err) {
        alert(`Error deleting video: ${err.message}`);
        console.error('Error deleting video:', err);
        if (deleteBtn) {
            deleteBtn.disabled = false;
            deleteBtn.textContent = '√ó';
        }
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDuration(seconds) {
    if (!seconds || seconds === 0) return 'N/A';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function getShockValueColor(score) {
    if (score >= 70) return '#dc3545'; // Red - high shock
    if (score >= 40) return '#ffc107'; // Yellow - medium shock
    return '#28a745'; // Green - low shock
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit'
    });
}

// Edit Metrics Modal
function openEditMetricsModal(video, cardElement) {
    // Create modal overlay
    const modal = document.createElement('div');
    modal.className = 'edit-metrics-modal';
    modal.innerHTML = `
        <div class="edit-metrics-modal-content">
            <div class="edit-metrics-modal-header">
                <h2>Edit Metrics - ${escapeHtml(video.trackName)}</h2>
                <button class="close-modal-btn">&times;</button>
            </div>
            <form id="editMetricsForm" class="edit-metrics-form">
                <div class="form-group">
                    <label>IG Hashtags</label>
                    <input type="text" id="edit-ig-hashtags" value="${escapeHtml(video.igHashtags || '')}" placeholder="e.g., #drumming #music">
                </div>
                <div class="form-group">
                    <label>TikTok Hashtags</label>
                    <input type="text" id="edit-tiktok-hashtags" value="${escapeHtml(video.tiktokHashtags || '')}" placeholder="e.g., #drumming #music">
                </div>
                <div class="form-group">
                    <label>IG Views</label>
                    <input type="number" id="edit-ig-views" value="${video.igViews || ''}" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label>IG Likes</label>
                    <input type="number" id="edit-ig-likes" value="${video.igLikes || ''}" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label>TikTok Views</label>
                    <input type="number" id="edit-tiktok-views" value="${video.tiktokViews || ''}" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label>TikTok Likes</label>
                    <input type="number" id="edit-tiktok-likes" value="${video.tiktokLikes || ''}" placeholder="0" min="0">
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn">Cancel</button>
                    <button type="submit" class="save-btn">Save</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal handlers
    const closeBtn = modal.querySelector('.close-modal-btn');
    const cancelBtn = modal.querySelector('.cancel-btn');
    const closeModal = () => {
        document.body.removeChild(modal);
    };
    
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    
    // Form submission
    const form = modal.querySelector('#editMetricsForm');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const metrics = {
            igHashtags: document.getElementById('edit-ig-hashtags').value.trim() || null,
            tiktokHashtags: document.getElementById('edit-tiktok-hashtags').value.trim() || null,
            igViews: document.getElementById('edit-ig-views').value ? parseInt(document.getElementById('edit-ig-views').value) : null,
            igLikes: document.getElementById('edit-ig-likes').value ? parseInt(document.getElementById('edit-ig-likes').value) : null,
            tiktokViews: document.getElementById('edit-tiktok-views').value ? parseInt(document.getElementById('edit-tiktok-views').value) : null,
            tiktokLikes: document.getElementById('edit-tiktok-likes').value ? parseInt(document.getElementById('edit-tiktok-likes').value) : null,
        };
        
        try {
            const response = await fetch(`/api/videos/${encodeURIComponent(video.s3Key)}/metrics`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(metrics)
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `Failed to update metrics: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Metrics updated:', data);
            
            // Reload videos to show updated data
            closeModal();
            loadVideos();
            
        } catch (err) {
            alert(`Error updating metrics: ${err.message}`);
            console.error('Error updating metrics:', err);
        }
    });
}

// Hashtag Suggestions Modal
async function openHashtagSuggestionsModal(video) {
    // Show loading state
    const modal = document.createElement('div');
    modal.className = 'hashtag-suggestions-modal';
    modal.innerHTML = `
        <div class="hashtag-suggestions-modal-content">
            <div class="hashtag-suggestions-modal-header">
                <h2>Hashtag Suggestions - ${escapeHtml(video.trackName)}</h2>
                <button class="close-modal-btn">&times;</button>
            </div>
            <div class="hashtag-suggestions-loading">
                <p>Analyzing historical data and generating recommendations...</p>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal handler
    const closeBtn = modal.querySelector('.close-modal-btn');
    const closeModal = () => {
        document.body.removeChild(modal);
    };
    
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    
    try {
        // Fetch hashtag suggestions from backend
        const response = await fetch(`/api/videos/${encodeURIComponent(video.s3Key)}/hashtag-suggestions`);
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `Failed to get suggestions: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Update modal with suggestions
        const loadingDiv = modal.querySelector('.hashtag-suggestions-loading');
        loadingDiv.innerHTML = `
            <div class="hashtag-suggestions-content">
                <div class="hashtag-platform-section">
                    <h3>üì∑ Instagram Hashtags</h3>
                    <div class="hashtag-list">
                        ${data.instagram.map((tag, index) => `
                            <span class="hashtag-tag ${index < 5 ? 'hashtag-top' : ''}" data-hashtag="${escapeHtml(tag)}">
                                ${escapeHtml(tag)}
                            </span>
                        `).join('')}
                    </div>
                    <button class="copy-hashtags-btn" data-platform="instagram">Copy Instagram Hashtags</button>
                </div>
                
                <div class="hashtag-platform-section">
                    <h3>üéµ TikTok Hashtags</h3>
                    <div class="hashtag-list">
                        ${data.tiktok.map((tag, index) => `
                            <span class="hashtag-tag ${index < 5 ? 'hashtag-top' : ''}" data-hashtag="${escapeHtml(tag)}">
                                ${escapeHtml(tag)}
                            </span>
                        `).join('')}
                    </div>
                    <button class="copy-hashtags-btn" data-platform="tiktok">Copy TikTok Hashtags</button>
                </div>
                
                <div class="hashtag-suggestions-footer">
                    <p class="hashtag-note">üí° Top 5 recommendations are highlighted. Click any hashtag to copy it individually.</p>
                </div>
            </div>
        `;
        
        // Add click handlers for individual hashtags
        modal.querySelectorAll('.hashtag-tag').forEach(tagEl => {
            tagEl.addEventListener('click', () => {
                const hashtag = tagEl.getAttribute('data-hashtag');
                navigator.clipboard.writeText(hashtag).then(() => {
                    tagEl.classList.add('hashtag-copied');
                    setTimeout(() => tagEl.classList.remove('hashtag-copied'), 1000);
                });
            });
        });
        
        // Add copy buttons
        modal.querySelectorAll('.copy-hashtags-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const platform = btn.getAttribute('data-platform');
                const hashtags = platform === 'instagram' ? data.instagram : data.tiktok;
                const text = hashtags.join(' ');
                navigator.clipboard.writeText(text).then(() => {
                    btn.textContent = '‚úì Copied!';
                    setTimeout(() => {
                        btn.textContent = platform === 'instagram' ? 'Copy Instagram Hashtags' : 'Copy TikTok Hashtags';
                    }, 2000);
                });
            });
        });
        
    } catch (err) {
        const loadingDiv = modal.querySelector('.hashtag-suggestions-loading');
        loadingDiv.innerHTML = `
            <div class="hashtag-suggestions-error">
                <p>Error loading suggestions: ${escapeHtml(err.message)}</p>
                <button class="retry-btn" onclick="location.reload()">Retry</button>
            </div>
        `;
        console.error('Error fetching hashtag suggestions:', err);
    }
}

// Load videos when page loads
loadVideos();
</script>

</body>
</html>

